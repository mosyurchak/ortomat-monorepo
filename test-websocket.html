<!DOCTYPE html>
<html>
<head>
    <title>Ortomat WebSocket Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #log { 
            border: 1px solid #ccc; 
            padding: 10px; 
            height: 400px; 
            overflow-y: scroll;
            background: #f5f5f5;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>🔌 Ortomat WebSocket Test Client</h1>
    <p>Device ID: <strong>locker-01</strong></p>
    <p>Status: <span id="status">Disconnected</span></p>
    <div id="log"></div>
    
    <script>
        const log = (msg, type = 'info') => {
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            document.getElementById('log').innerHTML += `<p class="${className}">${time}: ${msg}</p>`;
            console.log(msg);
            
            // Auto-scroll
            const logDiv = document.getElementById('log');
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        // Підключення до WebSocket
        const socket = io('http://localhost:3001/ws', {
            query: {
                device_id: 'locker-01',
                token: 'devtoken-01'
            },
            transports: ['websocket']
        });

        socket.on('connect', () => {
            document.getElementById('status').textContent = 'Connected ✅';
            document.getElementById('status').style.color = 'green';
            log('✅ Connected to backend', 'success');
            
            // Відправляємо hello
            socket.emit('hello', {
                type: 'hello',
                device_id: 'locker-01',
                ts_ms: Date.now()
            });
            log('👋 Sent hello message', 'info');
        });

        socket.on('message', (data) => {
            log(`📨 Received: ${JSON.stringify(data)}`, 'info');
            
            // Якщо це команда - відповідаємо
            if (data.type === 'cmd') {
                log(`🔓 Opening cell ${data.cell}`, 'success');
                
                // ACK
                socket.emit('ack', {
                    type: 'ack',
                    cmd_id: data.cmd_id,
                    ts_ms: Date.now()
                });
                log(`✅ Sent ACK for ${data.cmd_id}`, 'success');
                
                // State после задержки
                setTimeout(() => {
                    socket.emit('state', {
                        type: 'state',
                        cmd_id: data.cmd_id,
                        cell: data.cell,
                        result: 'opened',
                        sensor: 1,
                        ts_ms: Date.now()
                    });
                    log(`📍 Sent state: cell ${data.cell} opened`, 'success');
                }, 100);
            }
        });

        socket.on('disconnect', () => {
            document.getElementById('status').textContent = 'Disconnected ❌';
            document.getElementById('status').style.color = 'red';
            log('❌ Disconnected from backend', 'error');
        });

        socket.on('error', (error) => {
            log(`❌ Error: ${error}`, 'error');
        });

        // Діагностика кожні 5 секунд
        setInterval(() => {
            if (socket.connected) {
                socket.emit('diag', {
                    type: 'diag',
                    device_id: 'locker-01',
                    uptime_ms: Date.now(),
                    wifi_rssi: Math.floor(Math.random() * 30) - 60 // -60 to -30
                });
                log('📊 Sent diagnostic info', 'info');
            }
        }, 5000);
    </script>
</body>
</html>